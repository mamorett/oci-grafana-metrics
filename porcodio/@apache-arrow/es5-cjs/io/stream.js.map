{"version":3,"sources":["io/stream.ts"],"names":[],"mappings":"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","file":"stream.js","sourcesContent":["// Licensed to the Apache Software Foundation (ASF) under one\n// or more contributor license agreements.  See the NOTICE file\n// distributed with this work for additional information\n// regarding copyright ownership.  The ASF licenses this file\n// to you under the Apache License, Version 2.0 (the\n// \"License\"); you may not use this file except in compliance\n// with the License.  You may obtain a copy of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing,\n// software distributed under the License is distributed on an\n// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n// KIND, either express or implied.  See the License for the\n// specific language governing permissions and limitations\n// under the License.\n\nimport streamAdapters from './adapters';\nimport { decodeUtf8 } from '../util/utf8';\nimport { ITERATOR_DONE, Readable, Writable, AsyncQueue } from './interfaces';\nimport { toUint8Array, joinUint8Arrays, ArrayBufferViewInput } from '../util/buffer';\n\nimport {\n    isPromise, isFetchResponse,\n    isIterable, isAsyncIterable,\n    isReadableDOMStream, isReadableNodeStream\n} from '../util/compat';\n\n/** @ignore */\nexport type WritableSink<T> = Writable<T> | WritableStream<T> | NodeJS.WritableStream | null;\n/** @ignore */\nexport type ReadableSource<T> = Readable<T> | PromiseLike<T> | AsyncIterable<T> | ReadableStream<T> | NodeJS.ReadableStream | null;\n\n/** @ignore */\nexport class AsyncByteQueue<T extends ArrayBufferViewInput = Uint8Array> extends AsyncQueue<Uint8Array, T> {\n    public write(value: ArrayBufferViewInput | Uint8Array) {\n        if ((value = toUint8Array(value)).byteLength > 0) {\n            return super.write(value as T);\n        }\n    }\n    public toString(sync: true): string;\n    public toString(sync?: false): Promise<string>;\n    public toString(sync = false) {\n        return sync\n            ? decodeUtf8(this.toUint8Array(true))\n            : this.toUint8Array(false).then(decodeUtf8);\n    }\n    public toUint8Array(sync: true): Uint8Array;\n    public toUint8Array(sync?: false): Promise<Uint8Array>;\n    public toUint8Array(sync = false) {\n        return sync ? joinUint8Arrays(this._values as any[])[0] : (async () => {\n            const buffers = [];\n            let byteLength = 0;\n            for await (const chunk of this) {\n                buffers.push(chunk);\n                byteLength += chunk.byteLength;\n            }\n            return joinUint8Arrays(buffers, byteLength)[0];\n        })();\n    }\n}\n\n/** @ignore */\nexport class ByteStream implements IterableIterator<Uint8Array> {\n    private source!: ByteStreamSource<Uint8Array>;\n    constructor(source?: Iterable<ArrayBufferViewInput> | ArrayBufferViewInput) {\n        if (source) {\n            this.source = new ByteStreamSource(streamAdapters.fromIterable(source));\n        }\n    }\n    [Symbol.iterator]() { return this; }\n    public next(value?: any) { return this.source.next(value); }\n    public throw(value?: any) { return this.source.throw(value); }\n    public return(value?: any) { return this.source.return(value); }\n    public peek(size?: number | null) { return this.source.peek(size); }\n    public read(size?: number | null) { return this.source.read(size); }\n}\n\n/** @ignore */\nexport class AsyncByteStream implements Readable<Uint8Array>, AsyncIterableIterator<Uint8Array> {\n    private source!: AsyncByteStreamSource<Uint8Array>;\n    constructor(source?: PromiseLike<ArrayBufferViewInput> | Response | ReadableStream<ArrayBufferViewInput> | NodeJS.ReadableStream | AsyncIterable<ArrayBufferViewInput> | Iterable<ArrayBufferViewInput>) {\n        if (source instanceof AsyncByteStream) {\n            this.source = (source as AsyncByteStream).source;\n        } else if (source instanceof AsyncByteQueue) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\n        } else if (isReadableNodeStream(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromNodeStream(source));\n        } else if (isReadableDOMStream<ArrayBufferViewInput>(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source));\n        } else if (isFetchResponse(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromDOMStream(source.body!));\n        } else if (isIterable<ArrayBufferViewInput>(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromIterable(source));\n        } else if (isPromise<ArrayBufferViewInput>(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\n        } else if (isAsyncIterable<ArrayBufferViewInput>(source)) {\n            this.source = new AsyncByteStreamSource(streamAdapters.fromAsyncIterable(source));\n        }\n    }\n    [Symbol.asyncIterator]() { return this; }\n    public next(value?: any) { return this.source.next(value); }\n    public throw(value?: any) { return this.source.throw(value); }\n    public return(value?: any) { return this.source.return(value); }\n    public get closed(): Promise<void> { return this.source.closed; }\n    public cancel(reason?: any) { return this.source.cancel(reason); }\n    public peek(size?: number | null) { return this.source.peek(size); }\n    public read(size?: number | null) { return this.source.read(size); }\n}\n\n/** @ignore */\ntype ByteStreamSourceIterator<T> = Generator<T, null, { cmd: 'peek' | 'read'; size?: number | null }>;\n/** @ignore */\ntype AsyncByteStreamSourceIterator<T> = AsyncGenerator<T, null, { cmd: 'peek' | 'read'; size?: number | null }>;\n\n/** @ignore */\nclass ByteStreamSource<T> {\n    constructor(protected source: ByteStreamSourceIterator<T>) {}\n    public cancel(reason?: any) { this.return(reason); }\n    public peek(size?: number | null): T | null { return this.next(size, 'peek').value; }\n    public read(size?: number | null): T | null { return this.next(size, 'read').value; }\n    public next(size?: number | null, cmd: 'peek' | 'read' = 'read') { return this.source.next({ cmd, size }); }\n    public throw(value?: any) { return Object.create((this.source.throw && this.source.throw(value)) || ITERATOR_DONE); }\n    public return(value?: any) { return Object.create((this.source.return && this.source.return(value)) || ITERATOR_DONE); }\n}\n\n/** @ignore */\nclass AsyncByteStreamSource<T> implements Readable<T> {\n\n    private _closedPromise: Promise<void>;\n    private _closedPromiseResolve?: (value?: any) => void;\n    constructor (protected source: ByteStreamSourceIterator<T> | AsyncByteStreamSourceIterator<T>) {\n        this._closedPromise = new Promise((r) => this._closedPromiseResolve = r);\n    }\n    public async cancel(reason?: any) { await this.return(reason); }\n    public get closed(): Promise<void> { return this._closedPromise; }\n    public async read(size?: number | null): Promise<T | null> { return (await this.next(size, 'read')).value; }\n    public async peek(size?: number | null): Promise<T | null> { return (await this.next(size, 'peek')).value; }\n    public async next(size?: number | null, cmd: 'peek' | 'read' = 'read') { return (await this.source.next({ cmd, size })); }\n    public async throw(value?: any) {\n        const result = (this.source.throw && await this.source.throw(value)) || ITERATOR_DONE;\n        this._closedPromiseResolve && this._closedPromiseResolve();\n        this._closedPromiseResolve = undefined;\n        return Object.create(result);\n    }\n    public async return(value?: any) {\n        const result = (this.source.return && await this.source.return(value)) || ITERATOR_DONE;\n        this._closedPromiseResolve && this._closedPromiseResolve();\n        this._closedPromiseResolve = undefined;\n        return Object.create(result);\n    }\n}\n"]}